# Migration Guide

This guide covers breaking changes introduced in Phase 5 of the router library. Follow each section in order to update your canister.

## 1. Rename Dynamic Parameter Files

**Before:** `:param.rs` or `:param/` directories (colon-prefixed)

**After:** `_param.rs` or `_param/` directories (underscore-prefixed)

Rename all dynamic parameter files and directories:

```sh
# Example: rename :postId/ to _postId/
mv src/routes/posts/:postId src/routes/posts/_postId
```

The `_param` naming convention produces valid Rust identifiers, eliminating the need for `#[path = "..."]` attributes in generated `mod.rs` files and enabling IDE navigation.

The param name is converted to `snake_case` for the generated `Params` struct field (e.g. `_postId` → `pub post_id: String`).

## 2. Rename Catch-All Wildcard Files

**Before:** `*.rs` (asterisk-prefixed)

**After:** `all.rs`

Rename any catch-all wildcard route files:

```sh
mv src/routes/files/*.rs src/routes/files/all.rs
```

The `all` filename is a valid Rust identifier. The build script maps it to a wildcard route (`/*`).

## 3. Update Handler Signatures

**Before:** Handlers received `(HttpRequest, RouteParams)`:

```rust
use ic_http_certification::{HttpRequest, HttpResponse};
use router_library::router::RouteParams;

pub fn get(req: HttpRequest, params: RouteParams) -> HttpResponse<'static> {
    let post_id = params.get("postId").unwrap();
    // ...
}
```

**After:** Handlers receive `RouteContext<Params>`:

```rust
use ic_http_certification::HttpResponse;
use router_library::RouteContext;

// `Params` is auto-generated by the build script in the parent mod.rs.
// For routes without dynamic segments, use `RouteContext<()>`.
use super::Params;

pub fn get(ctx: RouteContext<Params>) -> HttpResponse<'static> {
    let post_id = &ctx.params.post_id;  // typed, no .get().unwrap()

    // Other context fields:
    // ctx.method  — the HTTP method
    // ctx.headers — request headers
    // ctx.body    — raw request body bytes
    // ctx.url     — the full request URL
    // ctx.query   — HashMap<String, String> of query parameters
    // ctx.search  — typed search params (if SearchParams struct is defined)
    // ...
}
```

For static routes (no dynamic parameters), use `RouteContext<()>`:

```rust
pub fn get(_ctx: RouteContext<()>) -> HttpResponse<'static> {
    // ...
}
```

## 4. Update `AssetConfig` Initialization

**Before:** `AssetConfig` had only `security_headers`, `cache_control`, and `custom_headers`.

**After:** `AssetConfig` adds `cache_config` for TTL-based caching:

```rust
fn setup() {
    router_library::set_asset_config(router_library::AssetConfig {
        security_headers: router_library::SecurityHeaders::permissive(),
        cache_control: router_library::CacheControl::default(),
        cache_config: router_library::CacheConfig::default(),  // new field
        custom_headers: vec![],
    });
}
```

If you use `AssetConfig::default()` or struct update syntax (`..AssetConfig::default()`), the new field is handled automatically.

## 5. Security Header Default Change

**Before:** Security headers were hardcoded to a strict set (HSTS, `X-Frame-Options: DENY`, `Cross-Origin-Embedder-Policy: require-corp`, etc.).

**After:** The default is `SecurityHeaders::permissive()`, which relaxes headers that commonly break external resources (fonts, CDN images, analytics scripts).

Key differences in the `permissive` preset compared to the old hardcoded headers:
- `X-Frame-Options: SAMEORIGIN` (was `DENY`)
- `Referrer-Policy: strict-origin-when-cross-origin` (was `no-referrer`)
- `Cross-Origin-Embedder-Policy` is **not set** (was `require-corp`)
- `Cross-Origin-Opener-Policy: same-origin-allow-popups` (was `same-origin`)
- `Cross-Origin-Resource-Policy: cross-origin` (was `same-origin`)
- `Permissions-Policy` is **not set** (was a restrictive policy)
- `X-DNS-Prefetch-Control` is **not set** (was `off`)

To restore the old strict behavior:

```rust
fn setup() {
    router_library::set_asset_config(router_library::AssetConfig {
        security_headers: router_library::SecurityHeaders::strict(),
        ..router_library::AssetConfig::default()
    });
}
```

Three presets are available:
- `SecurityHeaders::strict()` — maximum security, matches pre-Phase 5 behavior
- `SecurityHeaders::permissive()` — the new default, suitable for most SPAs
- `SecurityHeaders::none()` — no security headers

## 6. Cache-Control Configurability

**Before:** `Cache-Control` headers were hardcoded (`public, max-age=31536000, immutable` for static assets, `public, no-cache, no-store` for dynamic assets).

**After:** Cache-Control is configurable via `CacheControl`:

```rust
router_library::CacheControl {
    static_assets: "public, max-age=3600".into(),
    dynamic_assets: "public, max-age=60".into(),
}
```

The defaults are unchanged — if you don't configure `CacheControl`, the behavior is identical to before.

## 7. Generated Route Tree Location

**Before:** The build script wrote `__route_tree.rs` into the `src/` directory.

**After:** The build script writes `__route_tree.rs` into `OUT_DIR` (the Cargo build output directory).

Update your `include!` in `lib.rs`:

```rust
// Before:
include!("__route_tree.rs");

// After:
mod route_tree {
    include!(concat!(env!("OUT_DIR"), "/__route_tree.rs"));
}
```

And update route tree references:

```rust
// Before:
fn http_request(req: HttpRequest) -> HttpResponse<'static> {
    ROUTES.with(|routes| { ... })
}

// After:
fn http_request(req: HttpRequest) -> HttpResponse<'static> {
    route_tree::ROUTES.with(|routes| { ... })
}
```

## 8. Middleware Signature (Unchanged)

Middleware functions are **not affected** by the handler signature change. Middleware still receives `(HttpRequest, &RouteParams, &next)`:

```rust
pub fn middleware(
    req: HttpRequest,
    params: &RouteParams,
    next: &dyn Fn(HttpRequest, &RouteParams) -> HttpResponse<'static>,
) -> HttpResponse<'static> {
    let response = next(req, params);
    response
}
```

## Quick Checklist

- [ ] Rename `:param.rs` / `:param/` to `_param.rs` / `_param/`
- [ ] Rename `*.rs` to `all.rs`
- [ ] Update handler signatures from `(HttpRequest, RouteParams)` to `RouteContext<Params>` (or `RouteContext<()>` for static routes)
- [ ] Update `include!` to use `OUT_DIR` path
- [ ] Add `cache_config` field if constructing `AssetConfig` with struct literal syntax
- [ ] Review security header behavior — default is now `permissive()` instead of `strict()`
- [ ] Rebuild (`cargo build`) — the build script regenerates `mod.rs` files with `Params` structs
