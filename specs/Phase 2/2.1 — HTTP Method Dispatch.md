# 2.1 — HTTP Method Dispatch

**Phase:** 2 — Method Routing & Middleware
**Priority:** High
**Status:** Not started

## Problem

Routes are matched by path only. There is no way to register different handlers for `GET` vs `POST` vs `PUT` vs `DELETE` on the same path. Handlers must check the method themselves, leading to boilerplate and error-prone code.

## Objective

Implement HTTP method-based routing using a Next.js-style file convention where route files export named functions per method.

## Design Decision

**Option B (Next.js-style file convention) was chosen over Option A (explicit method attributes).** Rationale from the user: "it keeps the file-based routing paradigm consistent and is more ergonomic." Option A would have used `#[method(GET)]` attributes on handler functions — functional but breaks the convention that the file structure *is* the routing config.

## Specification

### File Convention

A route file exports named handler functions matching HTTP methods:

```rust
// src/routes/api/users.rs

/// GET /api/users — list all users
pub fn get(req: HttpRequest, params: RouteParams) -> HttpResponse<'static> {
    // ...
}

/// POST /api/users — create a user
pub fn post(req: HttpRequest, params: RouteParams) -> HttpResponse<'static> {
    // ...
}
```

Supported method names: `get`, `post`, `put`, `patch`, `delete`, `head`, `options`.

**No backward compatibility with the old `handler` convention.** Route files must export named method functions. The old `pub fn handler(...)` catch-all pattern is removed entirely — this is a clean break.

### Code Generator Changes

`build.rs` must:
1. Parse each route file to detect which method functions are exported (`get`, `post`, etc.)
2. Register each method separately in the route tree
3. Generate 405 Method Not Allowed responses for paths that exist but don't handle the requested method, including an `Allow` header listing supported methods
4. Emit a compile-time error if a route file exports no recognized method functions

### Router Changes

The `RouteNode` trie stores handlers per method only:

```rust
pub struct RouteNode {
    pub handlers: HashMap<Method, HandlerFn>,
    pub children: HashMap<String, RouteNode>,
    pub param_child: Option<Box<RouteNode>>,
    pub wildcard_child: Option<Box<RouteNode>>,
}
```

Route matching:
1. Find the node by path (existing trie logic)
2. Check for a method-specific handler
3. If the node exists but has no handler for the method → 405
4. If no node matches → 404

### ICP Considerations

- `ic-http-certification` already exposes `HttpRequest::method()` returning `&http::Method`
- Mutating methods (`POST`, `PUT`, `DELETE`) will almost always flow through `http_request_update` (update call path) since query calls cannot modify canister state
- The router must ensure method dispatch works identically in both `http_request` and `http_request_update`
- The upgrade mechanism should trigger correctly when a non-GET request arrives at the query endpoint

### 405 Response

```rust
fn method_not_allowed(allowed: &[Method]) -> HttpResponse<'static> {
    let allow = allowed.iter().map(|m| m.as_str()).collect::<Vec<_>>().join(", ");
    HttpResponse::builder()
        .with_status_code(405)
        .with_headers(vec![
            ("allow".to_string(), allow),
            ("content-type".to_string(), "text/plain".to_string()),
        ])
        .with_body(b"Method Not Allowed")
        .build()
}
```

## Files to Modify

- `src/router.rs` — Add method-aware handler storage and lookup
- `src/build.rs` — Detect method exports in route files, generate method-specific registrations
- `src/lib.rs` — Pass method to router lookup in both `http_request` and `http_request_update`

## Acceptance Criteria

- [ ] `get` and `post` exports in the same file route to different handlers
- [ ] A request with an unsupported method returns 405 with correct `Allow` header
- [ ] Method routing works in both query and update call paths
- [ ] `POST`/`PUT`/`DELETE` requests correctly trigger upgrade to update call
- [ ] Code generator correctly parses method exports from route files
- [ ] Code generator emits compile-time error if no recognized method functions are exported
- [ ] Tests cover: method dispatch, 405 responses, upgrade flow
