# 2.3 — Custom 404 Response

**Phase:** 2 — Method Routing & Middleware
**Priority:** Medium
**Status:** Not started

## Problem

The 404 response is hardcoded as a plain-text `"Not Found"` string. Consumers cannot return a styled HTML error page, a JSON error body, or any other custom response when no route matches.

## Objective

Allow consumers to provide a custom not-found handler.

## Specification

### Design Principle

Same as middleware: programmatic API is the foundation, file convention is sugar.

### Programmatic API (Foundation)

```rust
router.set_not_found(my_404_handler);
```

The handler has the same signature as a route handler but receives empty params:

```rust
pub fn my_404_handler(req: HttpRequest, params: RouteParams) -> HttpResponse<'static> {
    // Return styled 404 page, JSON error, etc.
}
```

When no route matches:
1. If a custom not-found handler is registered → call it with the request
2. If no custom handler → return the default plain-text 404

### File Convention (Sugar)

```
src/routes/not_found.rs   →  router.set_not_found(...)
```

Exports a method function following the same convention as regular routes (see 2.1):
```rust
// src/routes/not_found.rs

pub fn get(req: HttpRequest, params: RouteParams) -> HttpResponse<'static> {
    // HTML 404 page for browser requests
}

pub fn post(req: HttpRequest, params: RouteParams) -> HttpResponse<'static> {
    // JSON error for API requests
}
```

If only one method handler is needed for all methods, the programmatic API allows registering a single function. The code generator maps each exported method function to the corresponding not-found response for that method.

### Integration with SPA Fallback (Phase 3)

When SPA fallback mode is enabled (Phase 3), the not-found handler should only trigger for requests that don't match the SPA fallback pattern. The precedence is:

1. Exact route match → handler
2. SPA fallback (if enabled) → serve fallback file
3. Custom 404 handler (if registered) → custom response
4. Default 404 → `"Not Found"`

### Note on Error Handlers

A generic `set_error_handler` for catching handler failures has limited value on ICP: Rust panics in WASM trap execution and cannot be caught. The places where the library itself can fail are addressed in Phase 1 (items 1.2 and 1.3) with proper error responses. This spec only covers the "no route matched" case.

## Files to Modify

- `src/lib.rs` — Check for custom not-found handler before returning default 404
- `src/router.rs` — Store the not-found handler
- `src/build.rs` — Detect `not_found.rs` and generate `router.set_not_found(...)` calls

## Acceptance Criteria

- [ ] Custom not-found handler receives the full `HttpRequest`
- [ ] Custom handler can return any content type (HTML, JSON, etc.)
- [ ] Default 404 behavior is preserved when no custom handler is set
- [ ] Programmatic API (`router.set_not_found`) works as the foundation
- [ ] File convention (`not_found.rs`) generates correct programmatic calls
- [ ] `not_found.rs` supports method-specific exports (consistent with 2.1)
- [ ] Not-found handler works in both query and update call paths
