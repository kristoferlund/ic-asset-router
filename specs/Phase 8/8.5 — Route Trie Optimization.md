# 8.5 — Route Trie Optimization

**Phase:** 8 — Code Quality & Robustness  
**Priority:** Medium  
**Effort:** Medium  
**Status:** Not started

## Problem

### Linear child scan

`RouteNode` stores children as `Vec<RouteNode>` (`src/router.rs:141`). Child lookup in `_match` does three sequential linear scans over `self.children`:
1. Static match (lines ~437-451)
2. Param match (lines ~453-467)
3. Wildcard match (lines ~469-485)

For routes with many sibling static segments (common in API routers: `/users`, `/posts`, `/comments`, `/settings`, etc.), each resolution step is O(n) where n = number of children.

### No structural enforcement of constraints

The trie allows multiple param children at the same level (e.g., `/:userId` and `/:postId` as siblings) — only the first match wins, silently ignoring the second. It also allows segments after a wildcard (`/files/*/edit`) which would be unreachable since `*` consumes all remaining segments.

### Route params not URL-decoded

Parameters captured from URL segments are stored raw (`src/router.rs:457`). A request to `/posts/hello%20world` produces `ctx.params.post_id == "hello%20world"` instead of the expected `"hello world"`. The `url_decode` function exists in `context.rs` but is not applied during parameter extraction.

## Objective

1. Replace `Vec<RouteNode>` with typed child storage for O(1) static lookup.
2. Add build-time validation for conflicting param children and unreachable post-wildcard segments.
3. URL-decode route parameters in the generated wrapper code.

## Specification

### 8.5.1 — Typed child storage

Replace:

```rust
children: Vec<RouteNode>,
```

With:

```rust
static_children: HashMap<String, RouteNode>,
param_child: Option<Box<RouteNode>>,
wildcard_child: Option<Box<RouteNode>>,
```

This makes:
- Static segment lookup O(1) via `HashMap::get`.
- Param child lookup O(1) via `Option::as_ref`.
- Wildcard lookup O(1) via `Option::as_ref`.
- The "at most one param child" and "at most one wildcard child" invariants enforced structurally.

Update all methods that access `children`: `_insert` / `get_or_create_node` (from 8.3), `_match`, `_resolve`, `skip_certified_paths`, `get_route_config`, etc.

### 8.5.2 — Build-time validation

In the build script (`src/build.rs`), after generating the route tree, emit `cargo:warning` diagnostics for:

1. **Conflicting param segments** — two directories at the same level with `_` prefix (e.g., `_userId/` and `_postId/` as siblings). This produces ambiguous routing.
2. **Unreachable post-wildcard segments** — an `all.rs` file in a directory that also has subdirectories or other route files. The wildcard consumes all remaining path segments, making sibling/child routes unreachable.

These are warnings, not errors, to avoid breaking existing projects.

### 8.5.3 — URL-decode route parameters

In the generated route wiring code (`src/build.rs`, the section that populates the `Params` struct), apply `url_decode` to each captured parameter value:

```rust
// Before (build.rs generated code)
post_id: raw_params.get("postId").cloned().unwrap_or_default(),

// After
post_id: ic_asset_router::url_decode(
    &raw_params.get("postId").cloned().unwrap_or_default()
).into_owned(),
```

Also URL-decode the wildcard value in the `RouteContext` construction:

```rust
wildcard: raw_params.get("*").map(|w| ic_asset_router::url_decode(w).into_owned()),
```

## Acceptance Criteria

- [ ] `RouteNode` uses `HashMap<String, RouteNode>` for static children and `Option<Box<RouteNode>>` for param/wildcard.
- [ ] Route resolution for static segments is O(1) per segment.
- [ ] Build script emits warnings for conflicting param segments and unreachable post-wildcard routes.
- [ ] `ctx.params.post_id` contains the URL-decoded value for `%20` → space, `%2F` → `/`, etc.
- [ ] `ctx.wildcard` contains the URL-decoded value.
- [ ] New unit test: route param with `%20` is decoded to space.
- [ ] New unit test: wildcard with encoded characters is decoded.
- [ ] All existing tests pass (update any that assert raw-encoded values).
- [ ] `cargo check` and `cargo doc --no-deps` pass.

## Files Modified

- `src/router.rs` — typed children, updated traversal
- `src/build.rs` — validation warnings, URL-decode in generated code
