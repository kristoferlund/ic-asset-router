# 8.1 — Decompose http_request Functions

**Phase:** 8 — Code Quality & Robustness  
**Priority:** Critical  
**Effort:** Large  
**Status:** Not started

## Problem

`http_request` in `src/lib.rs` is 320 lines with 4 levels of nesting (`match > match > match > enum + match`). The `opts.certify == true` branch alone is ~200 lines. The 404 handling under `RouteResult::NotFound` is another ~100 lines with its own `canonical_state` sub-flow. `http_request_update` has similar structural issues at ~170 lines.

This makes both functions extremely hard to reason about, audit, test, and modify without introducing regressions.

Additionally, the TTL expiry check — a ~15-line block that checks the asset's own TTL, then falls back to the global `CacheConfig` — is copy-pasted 4 times across these functions with subtle variations. If the expiry semantics change, all 4 sites must be updated in lockstep.

## Objective

1. Extract the TTL expiry check into a single reusable function.
2. Decompose `http_request` into focused helper functions, each under ~50 lines.
3. Decompose `http_request_update` similarly.
4. No behavioral changes — this is a pure refactor.

## Specification

### 8.1.1 — Extract TTL expiry check

Create a function on `CertifiedAsset` or as a free function:

```rust
/// Check whether an asset is expired, considering both the asset's own TTL
/// and the global CacheConfig fallback.
fn is_asset_expired(asset: &CertifiedAsset, path: &str, now_ns: u64) -> bool
```

This replaces the 4 inline copies at:
- `http_request` Found/Valid branch (~line 880)
- `http_request` NotFound/canonical_state branch (~line 953)
- `http_request_update` NotFound/cached_valid branch (~line 1272)
- Any other occurrence

The function checks:
1. If `asset.ttl.is_some()`, delegate to `asset.is_expired(now_ns)`.
2. Otherwise, read `ROUTER_CONFIG` for `effective_ttl(path)` and compute expiry from `asset.certified_at`.
3. Return `false` if no TTL applies.

### 8.1.2 — Extract http_request helpers

Break `http_request` into these focused functions:

| Function | Responsibility |
|----------|---------------|
| `serve_uncertified(root, path, handler, req, params)` | The `certify == false` branch: run handler, attach skip proof |
| `serve_skip_mode(root, path, handler, req, params)` | The `Skip` certification mode branch (nearly identical to uncertified) |
| `serve_from_cache(req, path)` | Check asset router, return cached certified response or `None` |
| `handle_not_found_query(req, path, root, opts)` | The entire `NotFound` branch for query path |

The top-level `http_request` becomes a thin dispatcher:

```rust
pub fn http_request(...) -> HttpResponse<'static> {
    // Parse path, check method, resolve route
    match resolve_result {
        Found(...) => match (cert_mode, opts.certify) {
            (_, false) => serve_uncertified(...),
            (Skip, true) => serve_skip_mode(...),
            (Full, true) => upgrade(),
            (_, true) => serve_from_cache_or_upgrade(...),
        },
        MethodNotAllowed(m) => method_not_allowed(&m),
        NotFound => handle_not_found_query(...),
    }
}
```

### 8.1.3 — Extract http_request_update helpers

Break `http_request_update` similarly:

| Function | Responsibility |
|----------|---------------|
| `handle_not_modified(req, path)` | The `HandlerResult::NotModified` branch: reset TTL, serve from cache |
| `handle_not_found_update(req, path, root)` | The `NotFound` branch: check canonical cache, run not-found handler, certify |

### 8.1.4 — Merge skip witness logic

`serve_uncertified` and `serve_skip_mode` share ~90% of their code (run handler, add CEL header, borrow tree, get certificate, build witness, add cert header). Extract the shared witness-attachment logic:

```rust
fn attach_skip_certification(path: &str, response: &mut HttpResponse) -> Result<(), HttpResponse>
```

Both callers invoke the handler, then call this function.

## Acceptance Criteria

- [ ] `is_asset_expired` exists as a single function; no inline TTL check remains.
- [ ] `http_request` top-level body is under 60 lines.
- [ ] `http_request_update` top-level body is under 60 lines.
- [ ] No helper function exceeds 80 lines.
- [ ] `cargo test` passes with no regressions.
- [ ] `cargo check` and `cargo doc --no-deps` pass with no new warnings.

## Files Modified

- `src/lib.rs` — primary target
- `src/asset_router.rs` — if `is_asset_expired` is added as a method on `CertifiedAsset`
