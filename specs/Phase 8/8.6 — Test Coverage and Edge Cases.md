# 8.6 — Test Coverage and Edge Cases

**Phase:** 8 — Code Quality & Robustness  
**Priority:** Medium  
**Effort:** Medium  
**Status:** Not started

## Problem

The audit identified several areas with missing test coverage for edge cases:

1. **`collect_encoded_variants`** (`src/assets.rs:~136`) only looks at top-level files in `dir`, not recursively. Compressed variants (`.gz`, `.br`) in subdirectories are silently missed. No tests verify this.

2. **Multiple param children at the same trie level** — the router does not prevent inserting `/:userId` and `/:postId` as siblings. Only the first `Param` child matches. No test documents this behavior or verifies it fails gracefully.

3. **Wildcard not at terminal position** — inserting `/files/*` followed by `/files/*/edit` makes `edit` unreachable. No test verifies this.

4. **`http_request_update` NotFound canonical 404 path** — the `cached_valid` check for the canonical 404 entry in the update path is only testable via e2e tests. The logic should be extracted (per 8.1) and unit-tested.

5. **`url_decode` with various malformed inputs** — the existing test covers `%en` but not: trailing `%`, lone `%` at end of string, `%` followed by one valid hex char then EOF, double-encoded values, null bytes (`%00`).

6. **`header_dedup` in config** — `AssetConfig::merged_headers` uses O(n*m) retain-based dedup. No test verifies that later headers override earlier ones with the same name (case-insensitive).

## Objective

Add targeted unit tests for the edge cases above, plus any others surfaced by the refactoring in specs 8.1–8.5.

## Specification

### 8.6.1 — url_decode edge cases

Add tests in `src/context.rs`:

```rust
#[test] fn url_decode_trailing_percent()       // "abc%" → "abc%"
#[test] fn url_decode_percent_one_hex_then_eof() // "abc%4" → "abc%4" (or best-effort)
#[test] fn url_decode_null_byte()               // "%00" → "\0"
#[test] fn url_decode_double_encoded()          // "%2520" → "%20" (single decode only)
#[test] fn url_decode_empty_string()            // "" → ""
#[test] fn url_decode_only_percent()            // "%" → "%"
```

### 8.6.2 — Router trie edge cases

Add tests in `src/router.rs`:

```rust
#[test] fn multiple_param_children_first_wins()     // insert /:a and /:b, verify /:a matches
#[test] fn wildcard_consumes_remaining_segments()    // /files/* matches /files/a/b/c
#[test] fn post_wildcard_segments_unreachable()      // /files/*/edit is never matched
#[test] fn empty_path_resolves_to_root()             // "/" matches root index
#[test] fn trailing_slash_normalization()             // "/about/" matches "/about"
```

### 8.6.3 — Asset certification edge cases

Add tests in `src/asset_router.rs` or `src/assets.rs`:

```rust
#[test] fn certify_asset_duplicate_path_replaces()   // re-certifying same path replaces old entry
#[test] fn delete_nonexistent_asset_is_noop()         // deleting missing path doesn't panic
```

### 8.6.4 — Config header dedup

Add tests in `src/config.rs`:

```rust
#[test] fn merged_headers_later_overrides_earlier()   // same key, later value wins
#[test] fn merged_headers_case_insensitive_override() // "Content-Type" overrides "content-type"
```

### 8.6.5 — is_asset_expired unit tests

After extracting the TTL expiry check (8.1.1), add direct unit tests:

```rust
#[test] fn asset_with_own_ttl_not_expired()
#[test] fn asset_with_own_ttl_expired()
#[test] fn asset_without_ttl_uses_global_config()
#[test] fn asset_without_ttl_no_global_config_never_expires()
#[test] fn static_asset_never_expires()
```

## Acceptance Criteria

- [ ] All tests listed above are implemented and pass.
- [ ] No new `#[allow(...)]` attributes added to suppress warnings in test code.
- [ ] `cargo test` reports no failures.
- [ ] Code coverage for `url_decode`, `_match`, and `merged_headers` measurably increases.

## Files Modified

- `src/context.rs` — url_decode tests
- `src/router.rs` — trie edge case tests
- `src/asset_router.rs` or `src/assets.rs` — certification tests
- `src/config.rs` — header dedup tests
- `src/lib.rs` — is_asset_expired tests (after 8.1)
