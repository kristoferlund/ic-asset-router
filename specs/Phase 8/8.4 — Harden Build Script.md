# 8.4 — Harden Build Script

**Phase:** 8 — Code Quality & Robustness  
**Priority:** Medium  
**Effort:** Medium  
**Status:** Not started

## Problem

### scan_pub_fns uses fragile text matching

`scan_pub_fns` in `src/build.rs` (lines ~717-733) detects handler functions by looking for `pub fn <name>(` as a literal string on trimmed lines. This misses:
- Multi-line signatures where `pub fn` and the function name are on different lines
- `pub fn get<T>(` (generic handlers, if ever supported)
- Functions inside `#[cfg(test)]` blocks (false positives)

Meanwhile, `scan_route_attribute`, `scan_certification_attribute`, and `has_search_params` all use `syn` to parse the AST. The inconsistency is unnecessary since `syn` is already a dependency.

### scan_route_attribute does fragile string matching on tokens

`scan_route_attribute` (lines ~776-822) tokenizes the attribute with `syn` but then does string matching on the serialized token stream using `tokens.find("path")`. This would incorrectly match substrings like `xpath` or `mypath` in attribute arguments.

### process_directory panics with unhelpful messages

`process_directory` (lines ~467-472) uses bare `.unwrap()` on filesystem operations:

```rust
for entry in fs::read_dir(dir).unwrap() {
    let entry = entry.unwrap();
```

And:

```rust
let name = path.file_name().unwrap().to_str().unwrap();
```

When these panic, users see `called 'Option::unwrap()' on a None value` with no indication of which directory or file caused the error.

## Objective

1. Migrate `scan_pub_fns` to use `syn` AST parsing.
2. Fix `scan_route_attribute` to use proper token parsing instead of string matching.
3. Add contextual panic messages to all filesystem operations in the build script.

## Specification

### 8.4.1 — Migrate scan_pub_fns to syn

Replace the text-based line scanner with `syn::parse_file` + `Item::Fn` iteration:

```rust
fn scan_pub_fns(path: &Path) -> Vec<String> {
    let source = fs::read_to_string(path)
        .unwrap_or_else(|e| panic!("failed to read {}: {e}", path.display()));
    let file = match syn::parse_file(&source) {
        Ok(f) => f,
        Err(_) => return vec![], // unparseable file — skip gracefully
    };
    file.items
        .iter()
        .filter_map(|item| {
            if let syn::Item::Fn(func) = item {
                if matches!(func.vis, syn::Visibility::Public(_)) {
                    return Some(func.sig.ident.to_string());
                }
            }
            None
        })
        .collect()
}
```

This correctly handles multi-line signatures, generics, and only detects truly `pub` functions.

### 8.4.2 — Fix scan_route_attribute token parsing

Replace the `tokens.find("path")` approach with proper `syn` meta parsing. Since the attribute is already parsed as a `syn::Attribute`, walk the `Meta::List` contents as `Punctuated<MetaNameValue, Token![,]>` or equivalent, and match on exact ident `path`.

### 8.4.3 — Add contextual panic messages

Replace all bare `.unwrap()` in `process_directory` and related functions with `.unwrap_or_else(|e| panic!("context: {e}", ...))` or `.expect("context")`, including the file path in the message.

Examples:

```rust
// Before
for entry in fs::read_dir(dir).unwrap() {

// After
for entry in fs::read_dir(dir)
    .unwrap_or_else(|e| panic!("failed to read directory {}: {e}", dir.display()))
{
```

## Acceptance Criteria

- [ ] `scan_pub_fns` uses `syn::parse_file` and `Item::Fn` iteration.
- [ ] `scan_route_attribute` does not use `tokens.find("path")` or any substring matching.
- [ ] No bare `.unwrap()` remains in the build script on filesystem or path operations.
- [ ] Existing build script tests pass.
- [ ] New test: `scan_pub_fns` correctly ignores private functions.
- [ ] New test: `scan_pub_fns` handles multi-line function signatures.
- [ ] `cargo check` passes.

## Files Modified

- `src/build.rs`
