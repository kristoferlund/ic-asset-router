# 6.1 — Not-Found Response Certification

## Problem

Custom 404 responses are not certified. When a request matches no route:

- In `http_request` (query path, `src/lib.rs:285-308`): the not-found handler's response is returned directly without certification headers. The boundary node cannot verify it and returns **503** to the client.
- In `http_request_update` (update path, `src/lib.rs:439-449`): the not-found handler's response bypasses `certify_dynamic_response()` entirely. The response is never cached or certified.

This means any custom `not_found.rs` handler is effectively broken in production — the boundary node rejects the uncertified response. Discovered during E2E testing (Phase 5, Session 13).

## Specification

### Query path (`http_request`)

When `RouteResult::NotFound` is reached and the path is not a static asset:

1. Check `DYNAMIC_CACHE` for a previously certified 404 response for this path.
2. If a cached certified response exists, serve it (same as any other cached dynamic response).
3. If no cached response exists, return `upgrade: true` to trigger the update path — same as any uncertified dynamic route.

This mirrors the existing behavior for regular dynamic routes: first request upgrades to update, subsequent requests serve from cache.

### Update path (`http_request_update`)

When `RouteResult::NotFound` is reached:

1. Execute the not-found handler (with middleware chain, as currently done).
2. Pass the resulting `HttpResponse` through `certify_dynamic_response(response, &path)` — the same function used for regular dynamic responses (`src/lib.rs:315-353`).
3. The response is now certified, cached in `DYNAMIC_CACHE`, and will be served from the query path on subsequent requests.

If no custom not-found handler is registered, the default plain-text `"Not Found"` response should also go through `certify_dynamic_response()`.

### Cache behavior

Certified 404 responses follow the same TTL and invalidation rules as any other dynamic response. If a route is later registered for that path, the next request will match the new route instead of the cached 404 (route matching happens before cache lookup).

### Files to modify

| File | Change |
|------|--------|
| `src/lib.rs:285-308` | Not-found branch in `http_request`: check cache, upgrade if uncertified |
| `src/lib.rs:439-449` | Not-found branch in `http_request_update`: pipe response through `certify_dynamic_response()` |

### Acceptance criteria

- [ ] `GET /nonexistent` returns **404** (not 503) with the custom not-found handler's body
- [ ] The response includes `IC-Certificate` header (certified)
- [ ] Security headers are present on the cached 404 response
- [ ] A second `GET /nonexistent` is served from the query path (no upgrade needed)
- [ ] Default plain-text 404 (no custom handler) is also certified
- [ ] Existing E2E test `test_custom_404_handler` updated to assert 404 status
- [ ] `cargo test` passes
