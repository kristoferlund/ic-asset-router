# 6.6 — Minor Fixes & Cleanup

## Problem

Several minor code quality issues accumulated during Phase 5 development. None are user-facing bugs, but they reduce maintainability.

## Specification

### Unify file scanning helpers

`has_pub_fn()` (`src/build.rs:628-640`) and `detect_method_exports()` (`src/build.rs:644-667`) both scan Rust source files for `pub fn <name>(` patterns using similar line-by-line logic.

Refactor into a single helper:

```rust
fn scan_pub_fns(path: &Path) -> Vec<String>
```

Returns all `pub fn` names found in the file. Then:

- `has_pub_fn(path, name)` becomes `scan_pub_fns(path).contains(&name.to_string())`
- `detect_method_exports(path)` filters `scan_pub_fns(path)` against the known HTTP method names

This reduces duplication and ensures both functions handle edge cases (comments, string literals, multi-line signatures) identically.

### Wrap `HandlerResultFn` with `RouteContext`

`HandlerResultFn` (`src/router.rs:30`) still uses the old signature:

```rust
pub type HandlerResultFn = fn(HttpRequest, RouteParams) -> HandlerResult;
```

For consistency with `HandlerFn` (which is now wrapped by the build script to accept `RouteContext`), `HandlerResultFn` should follow the same pattern. However, since `insert_result` is not currently called from generated code, this is a consistency-only change:

- Update the type alias to document that it uses the internal (unwrapped) signature.
- If `insert_result` is ever wired into `__route_tree.rs` generation, the wrapper pattern from spec 5.2 should be applied to result handlers too.

For now: add a doc comment to `HandlerResultFn` noting the intentional divergence and the path to alignment.

### Clean up `process_directory` test temp dirs

The `setup_temp_routes` helper in `build.rs` tests creates temp directories with monotonic IDs but never cleans them up. Use `tempfile::TempDir` (already a common pattern in Rust) or add cleanup in test teardown.

Check if `tempfile` is already a dev-dependency. If not, the simplest fix is to use `std::env::temp_dir()` with a unique subdirectory and clean up in a `Drop` guard.

### Files to modify

| File | Change |
|------|--------|
| `src/build.rs:628-667` | Unify `has_pub_fn` and `detect_method_exports` into shared scanner |
| `src/router.rs:30` | Add doc comment to `HandlerResultFn` explaining the internal signature |
| `src/build.rs` (test module) | Use proper temp dir cleanup in `setup_temp_routes` |

### Acceptance criteria

- [ ] `has_pub_fn` and `detect_method_exports` share a common scanning function
- [ ] `HandlerResultFn` has a doc comment explaining the internal vs. public signature distinction
- [ ] `process_directory` tests clean up their temp directories
- [ ] `cargo test` passes
- [ ] No behavioral changes — all existing tests produce the same results
