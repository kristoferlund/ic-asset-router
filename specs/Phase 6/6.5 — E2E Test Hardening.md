# 6.5 — E2E Test Hardening

## Problem

The Phase 5 E2E test suite (spec 5.7) has three gaps identified during Session 13:

1. **No invalidation test endpoint.** The test canister has no Candid method to call `invalidate_path()`, so cache invalidation cannot be tested end-to-end. The existing `test_cache_invalidation_via_update_call` only verifies that cached responses persist — it cannot trigger actual invalidation.

2. **No TTL expiry test.** The test canister does not configure a TTL, so `test_ttl_expiry_regeneration` only verifies that responses persist without TTL. A proper test would configure a short TTL, use `pic.advance_time()` to simulate passage of time, and verify that the cached response is regenerated.

3. **404 test asserts wrong status.** `test_custom_404_handler` currently asserts 503 (boundary node rejection) because 404 responses are not certified. After spec 6.1 is implemented, this test should assert 404.

## Specification

### Invalidation endpoint

Add two Candid update methods to the test canister (`tests/e2e/test_canister/src/lib.rs`):

```rust
#[update]
fn invalidate(path: String) {
    router_library::invalidate_path(&path);
}

#[update]
fn invalidate_all() {
    router_library::invalidate_all_dynamic();
}
```

Update `test_canister.did` with the new methods.

### Invalidation E2E test

Replace the existing `test_cache_invalidation_via_update_call` with a proper test:

1. `GET /posts/42` — first request, triggers update, response cached.
2. `GET /posts/42` — second request, served from cache (verify same body).
3. Call `invalidate("/posts/42")` via Candid.
4. `GET /posts/42` — third request. The cached response was invalidated, so this should trigger a new update call.
5. Verify the response is valid (200, correct body).

### TTL expiry test

Configure the test canister with a short TTL (e.g., 5 seconds) for a specific route (e.g., `/ttl-test`):

1. Add a `/ttl-test` route to the test canister that returns a timestamp or counter.
2. Configure `CacheConfig` with `per_route_ttl` for `/ttl-test`.
3. `GET /ttl-test` — first request, triggers update.
4. `GET /ttl-test` — second request, served from cache.
5. `pic.advance_time(Duration::from_secs(10))` + `pic.tick()`.
6. `GET /ttl-test` — third request. TTL expired, should trigger update again.
7. Verify the response reflects a fresh generation (different timestamp or confirmed re-execution).

### 404 test update

*Depends on: spec 6.1 being implemented first.*

Update `test_custom_404_handler`:

1. `GET /nonexistent` — first request, triggers update, 404 response is certified and cached.
2. `GET /nonexistent` — second request, served from cache.
3. Assert status **404** (not 503).
4. Assert body contains custom not-found handler output.
5. Assert `IC-Certificate` header is present.

### Files to modify

| File | Change |
|------|--------|
| `tests/e2e/test_canister/src/lib.rs` | Add `invalidate()` and `invalidate_all()` Candid methods, configure TTL |
| `tests/e2e/test_canister/test_canister.did` | Add `invalidate` and `invalidate_all` method signatures |
| `tests/e2e/test_canister/src/routes/` | Add TTL test route |
| `tests/e2e/src/lib.rs` | Update invalidation test, add TTL test, update 404 test |

### Acceptance criteria

- [ ] Test canister exposes `invalidate(path: text)` and `invalidate_all()` Candid methods
- [ ] Invalidation test verifies that a cached response is evicted after `invalidate()` call
- [ ] TTL test verifies that a cached response expires after `advance_time()` past the TTL
- [ ] 404 test asserts status 404 with certified response (after spec 6.1)
- [ ] All E2E tests pass via `build_and_test.sh`
- [ ] Library unit tests (`cargo test`) still pass
