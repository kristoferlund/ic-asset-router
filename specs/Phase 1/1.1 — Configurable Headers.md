# 1.1 — Configurable Headers

**Phase:** 1 — Fix Foundations
**Priority:** Critical
**Status:** Not started

## Problem

All security headers are hardcoded in `src/assets.rs:90-105`. Every asset — static and dynamic — gets the same immutable set:

| Header | Hardcoded Value | Problem |
|--------|----------------|---------|
| `cross-origin-embedder-policy` | `require-corp` | Breaks loading cross-origin resources (Google Fonts, CDN images, analytics) |
| `x-frame-options` | `DENY` | Prevents all iframe embedding, even legitimate use cases |
| `permissions-policy` | Very restrictive | Disables camera, geolocation, etc. even if the app needs them |
| `referrer-policy` | `no-referrer` | Breaks integrations that rely on referrer info |

The `content-security-policy` header is commented out but would have the same problem if enabled.

There is no way for a consumer of this library to override, remove, or extend these headers.

## Objective

Replace the hardcoded security headers with a configuration system that:
1. Provides sensible defaults
2. Offers presets for common scenarios
3. Allows per-route overrides
4. Allows consumers to add custom headers

## Specification

### Design Rationale: Typed Set + Escape Hatch

There is no formal standard defining a closed set of "security headers." The concept is an industry convention maintained by projects like OWASP Secure Headers and libraries like Helmet.js. Each header comes from its own separate RFC or W3C draft. The set evolves over time — new headers appear (COOP, COEP, CORP all arrived 2019-2021) and old ones get deprecated (`X-XSS-Protection`, `Expect-CT`, `Public-Key-Pins`).

Two approaches exist in practice:

1. **Fixed typed struct** (Helmet.js) — A closed type with one field per known header. Good defaults, IDE completion, prevents typos. But cannot express headers the library doesn't know about yet.
2. **Flexible key-value** (Next.js, nginx) — Open `Vec<(String, String)>`. Supports any header, but no defaults, no type safety, easy to misconfigure.

This library uses **both**: a typed struct for the well-known headers (based on the OWASP active list and Helmet.js defaults), plus a `custom_headers` escape hatch for anything else. When a new security header is adopted by browsers, consumers can use it immediately via `custom_headers` without waiting for a library update.

### New Types

```rust
pub struct AssetConfig {
    pub security_headers: SecurityHeaders,
    pub custom_headers: Vec<HeaderField>,
}

/// Typed fields for well-known security headers.
///
/// Based on the OWASP Secure Headers Project "active" list and Helmet.js defaults.
/// Each field is `Option<String>` — `None` means the header is not emitted.
///
/// For headers not covered by this struct, use `AssetConfig::custom_headers`.
pub struct SecurityHeaders {
    /// `Strict-Transport-Security` — Forces HTTPS, prevents protocol downgrade (RFC 6797).
    /// Example: `"max-age=31536000; includeSubDomains"`
    pub hsts: Option<String>,

    /// `Content-Security-Policy` — Controls which resources the browser can load.
    /// Primary defense against XSS. Complex to configure; `None` by default.
    /// Example: `"default-src 'self'; script-src 'self'"`
    pub csp: Option<String>,

    /// `X-Content-Type-Options` — Prevents MIME-type sniffing.
    /// The only valid value is `"nosniff"`.
    pub content_type_options: Option<String>,

    /// `X-Frame-Options` — Controls iframe embedding (legacy; superseded by CSP `frame-ancestors`).
    /// Values: `"DENY"`, `"SAMEORIGIN"`.
    pub frame_options: Option<String>,

    /// `Referrer-Policy` — Controls referrer information sent with requests.
    /// Values: `"no-referrer"`, `"strict-origin-when-cross-origin"`, etc.
    pub referrer_policy: Option<String>,

    /// `Permissions-Policy` — Controls which browser APIs are allowed (camera, geolocation, etc.).
    /// Replaces deprecated `Feature-Policy`. Still a W3C working draft but widely supported.
    /// Example: `"camera=(), microphone=(), geolocation=()"`
    pub permissions_policy: Option<String>,

    /// `Cross-Origin-Embedder-Policy` — Controls loading of cross-origin resources.
    /// Values: `"require-corp"`, `"credentialless"`, `"unsafe-none"`.
    /// Warning: `"require-corp"` breaks Google Fonts, CDN images, analytics scripts.
    pub coep: Option<String>,

    /// `Cross-Origin-Opener-Policy` — Process-isolates the document, prevents XS-Leaks.
    /// Values: `"same-origin"`, `"same-origin-allow-popups"`, `"unsafe-none"`.
    pub coop: Option<String>,

    /// `Cross-Origin-Resource-Policy` — Controls which origins can load a resource.
    /// Mitigates Spectre side-channel attacks.
    /// Values: `"same-origin"`, `"same-site"`, `"cross-origin"`.
    pub corp: Option<String>,

    /// `X-DNS-Prefetch-Control` — Controls DNS prefetching, which can leak browsing intent.
    /// Values: `"off"`, `"on"`.
    pub dns_prefetch_control: Option<String>,

    /// `X-Permitted-Cross-Domain-Policies` — Controls cross-domain policy for Flash/PDF.
    /// Values: `"none"`, `"master-only"`, `"by-content-type"`, `"all"`.
    pub permitted_cross_domain_policies: Option<String>,
}
```

### Why These Fields

Cross-referencing OWASP's active list with Helmet.js defaults:

| Header | OWASP Active | Helmet Default | In Struct |
|--------|:---:|:---:|:---:|
| `Strict-Transport-Security` | Yes | Yes | `hsts` |
| `Content-Security-Policy` | Yes | Yes | `csp` |
| `X-Content-Type-Options` | Yes | Yes | `content_type_options` |
| `X-Frame-Options` | Yes | Yes | `frame_options` |
| `Referrer-Policy` | Yes | Yes | `referrer_policy` |
| `Permissions-Policy` | Yes | No (off by default) | `permissions_policy` |
| `Cross-Origin-Embedder-Policy` | Yes | No (off by default) | `coep` |
| `Cross-Origin-Opener-Policy` | Yes | Yes | `coop` |
| `Cross-Origin-Resource-Policy` | Yes | Yes | `corp` |
| `X-DNS-Prefetch-Control` | Yes | Yes | `dns_prefetch_control` |
| `X-Permitted-Cross-Domain-Policies` | Yes | Yes | `permitted_cross_domain_policies` |
| `Clear-Site-Data` | Yes | No | Via `custom_headers` (context-specific, e.g., logout flows) |
| `X-XSS-Protection` | **Deprecated** | Set to `0` | **Excluded** — actively harmful |
| `Expect-CT` | **Deprecated** | No | **Excluded** |
| `X-Powered-By` | Remove if present | Removed | N/A (library never sets it) |

`Clear-Site-Data` is intentionally excluded from the struct — it's used in specific contexts (logout endpoints) rather than as a global default. It can be set via `custom_headers` when needed.

`X-XSS-Protection` is explicitly **not** included. It's deprecated and its filter mechanism could be exploited. Modern guidance is to not set it at all, or set it to `0` only if you need to override a server that injects it.

### Presets

```rust
impl SecurityHeaders {
    /// Strict — mirrors current hardcoded behavior plus missing headers.
    /// Suitable for apps that don't load cross-origin resources.
    pub fn strict() -> Self {
        Self {
            hsts: Some("max-age=31536000; includeSubDomains".into()),
            csp: None, // Too application-specific to set a default
            content_type_options: Some("nosniff".into()),
            frame_options: Some("DENY".into()),
            referrer_policy: Some("no-referrer".into()),
            permissions_policy: Some("accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=(), interest-cohort=()".into()),
            coep: Some("require-corp".into()),
            coop: Some("same-origin".into()),
            corp: Some("same-origin".into()),
            dns_prefetch_control: Some("off".into()),
            permitted_cross_domain_policies: Some("none".into()),
        }
    }

    /// Permissive — allows cross-origin resources, iframe embedding, common permissions.
    /// Suitable for SPAs loading external fonts, images, scripts.
    pub fn permissive() -> Self {
        Self {
            hsts: Some("max-age=31536000; includeSubDomains".into()),
            csp: None,
            content_type_options: Some("nosniff".into()),
            frame_options: Some("SAMEORIGIN".into()),
            referrer_policy: Some("strict-origin-when-cross-origin".into()),
            permissions_policy: None,
            coep: None, // Not set — avoids breaking cross-origin resources
            coop: Some("same-origin-allow-popups".into()),
            corp: Some("cross-origin".into()),
            dns_prefetch_control: None,
            permitted_cross_domain_policies: Some("none".into()),
        }
    }

    /// No security headers — consumer takes full responsibility.
    pub fn none() -> Self {
        Self {
            hsts: None,
            csp: None,
            content_type_options: None,
            frame_options: None,
            referrer_policy: None,
            permissions_policy: None,
            coep: None,
            coop: None,
            corp: None,
            dns_prefetch_control: None,
            permitted_cross_domain_policies: None,
        }
    }
}

impl Default for SecurityHeaders {
    fn default() -> Self {
        // Permissive by default to avoid breaking common use cases (external fonts, CDN images)
        Self::permissive()
    }
}
```

### Custom Headers (Escape Hatch)

`AssetConfig::custom_headers` is a `Vec<HeaderField>` that allows setting any HTTP header not covered by the `SecurityHeaders` struct. This includes:

- Future security headers not yet added to the struct
- Application-specific headers (e.g., `Clear-Site-Data` on logout endpoints)
- Non-security headers that should be present on all responses

Custom headers are appended **after** security headers. If a custom header has the same name as a security header, the custom header wins (last-write-wins semantics).

### Integration Points

1. **Global config** — Set once during canister initialization:
   ```rust
   AssetRouter::new(AssetConfig {
       security_headers: SecurityHeaders::strict(),
       ..Default::default()
   });
   ```

2. **Per-route overrides** — A route can specify different headers:
   ```rust
   // In route registration or handler return
   pub fn handler(req: HttpRequest, params: RouteParams) -> HttpResponse<'static> {
       // Response with custom headers that override globals
   }
   ```

3. **Header merging** — Per-route headers override global headers of the same name. The merge order is: security headers (from struct) -> custom_headers (from config) -> per-route headers (from handler). Last-write-wins for duplicate header names.

## Files to Modify

- `src/assets.rs` — Remove hardcoded headers, use `AssetConfig`
- `src/lib.rs` — Accept `AssetConfig` in initialization
- New file: `src/config.rs` — Types and presets

## Acceptance Criteria

- [ ] No hardcoded security headers remain in the codebase
- [ ] `SecurityHeaders` struct covers all 11 headers (HSTS, CSP, X-Content-Type-Options, X-Frame-Options, Referrer-Policy, Permissions-Policy, COEP, COOP, CORP, X-DNS-Prefetch-Control, X-Permitted-Cross-Domain-Policies)
- [ ] `X-XSS-Protection` is not set anywhere (deprecated, harmful)
- [ ] `SecurityHeaders::strict()` reproduces current behavior plus adds CORP, X-DNS-Prefetch-Control, X-Permitted-Cross-Domain-Policies
- [ ] `SecurityHeaders::permissive()` is the new default — allows cross-origin resources, SAMEORIGIN framing
- [ ] `SecurityHeaders::none()` produces zero security headers
- [ ] `custom_headers` escape hatch allows arbitrary headers not covered by the struct
- [ ] Custom headers override security headers of the same name (last-write-wins)
- [ ] Per-route headers override global headers of the same name
- [ ] Merge order is documented: security headers -> custom_headers -> per-route headers
- [ ] All existing tests pass (with updated expectations)
- [ ] New tests cover each preset, override behavior, and custom header merging
