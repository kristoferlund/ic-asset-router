# 1.2 — Handler-Controlled Response Metadata

**Phase:** 1 — Fix Foundations
**Priority:** Critical
**Status:** Not started

## Problem

In `src/lib.rs:101`, all dynamically generated assets are certified with:

```rust
content_type: Cow::Borrowed("text/html")
```

This is hardcoded regardless of what the handler actually returns. A handler returning JSON will have its certification metadata declare it as HTML, which is incorrect and breaks API endpoints.

## Objective

Let the handler's actual response determine the content type used for certification, rather than hardcoding `text/html`.

## Specification

### Option A: Extract from HttpResponse (minimal change)

When certifying a dynamic response, read the `content-type` header from the `HttpResponse` that the handler returned. Fall back to `application/octet-stream` if no content-type header is present.

```rust
// In http_request_update, after calling the handler:
let response = handler(req, params);
let content_type = response
    .headers()
    .iter()
    .find(|(k, _)| k.eq_ignore_ascii_case("content-type"))
    .map(|(_, v)| v.clone())
    .unwrap_or_else(|| "application/octet-stream".to_string());

// Use this content_type when certifying
```

### Option B: Richer response type (more work, better DX)

Introduce a `DynamicResponse` type that handlers can return instead of raw `HttpResponse`:

```rust
pub struct DynamicResponse {
    pub body: Vec<u8>,
    pub content_type: String,
    pub status_code: u16,
    pub headers: Vec<HeaderField>,
    pub cache_control: Option<String>,
}
```

With convenience constructors:
```rust
impl DynamicResponse {
    pub fn html(body: impl Into<Vec<u8>>) -> Self { ... }
    pub fn json(body: impl Serialize) -> Self { ... }
    pub fn text(body: impl Into<String>) -> Self { ... }
}
```

### Recommendation

Start with **Option A** — it's a minimal, non-breaking fix. Option B can come later as a DX improvement.

## Files to Modify

- `src/lib.rs` — Change the certification path in `http_request_update` to extract content-type from the handler response

## Acceptance Criteria

- [ ] A handler returning `content-type: application/json` produces correct certification metadata
- [ ] A handler returning `content-type: text/html` still works (regression check)
- [ ] A handler returning no content-type header falls back to `application/octet-stream`
- [ ] The certified response can be verified by the ICP boundary node for non-HTML content types
- [ ] Tests cover JSON, HTML, plain text, and missing content-type scenarios
