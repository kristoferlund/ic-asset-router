# 1.3 — Graceful Error Handling

**Phase:** 1 — Fix Foundations
**Priority:** Critical
**Status:** Not started

## Problem

`req.get_path().unwrap()` at `src/lib.rs:40` and `src/lib.rs:91` will trap (crash) the canister on malformed URLs instead of returning a proper HTTP error response. A trapped canister is unavailable until the next request, and the caller gets an opaque system error rather than a meaningful 400 status.

## Objective

Replace all `unwrap()` calls on potentially fallible operations with proper HTTP error responses.

## Specification

### Error Mapping

| Failure | Current Behavior | Target Behavior |
|---------|-----------------|-----------------|
| Malformed URL / path extraction | Canister trap | 400 Bad Request |
| Missing certificate tree | Canister trap | 500 Internal Server Error |
| Handler panic | Canister trap (unavoidable in WASM) | Document as known limitation |

### Implementation

```rust
// Before (traps on bad input):
let path = req.get_path().unwrap();

// After (returns 400):
let path = match req.get_path() {
    Ok(p) => p,
    Err(_) => return HttpResponse::builder()
        .with_status_code(400)
        .with_body(b"Bad Request: malformed URL")
        .build(),
};
```

Apply the same pattern to all `unwrap()` calls in `lib.rs` that operate on request data.

### Helper Function

Consider a small helper to reduce boilerplate:

```rust
fn error_response(status: u16, message: &str) -> HttpResponse<'static> {
    HttpResponse::builder()
        .with_status_code(status)
        .with_headers(vec![("content-type".to_string(), "text/plain".to_string())])
        .with_body(message.as_bytes().to_vec())
        .build()
}
```

### Note on Handler Panics

Rust panics in WASM canisters trap execution and cannot be caught with `catch_unwind` (WASM has no unwinding support). This is a platform limitation, not something this library can fix. Document it clearly in the README.

## Files to Modify

- `src/lib.rs:40, 91` — Replace `unwrap()` with match/error response
- Audit all other `unwrap()` calls in the codebase for similar issues

## Acceptance Criteria

- [ ] A malformed URL returns HTTP 400, not a canister trap
- [ ] All `unwrap()` calls on request data are replaced with proper error handling
- [ ] A missing certificate tree returns HTTP 500 with a descriptive message
- [ ] Handler panics are documented as a known platform limitation
- [ ] No `unwrap()` on user-provided input remains in `lib.rs`
